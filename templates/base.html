<!DOCTYPE html>
<html lang="ru" data-bs-theme="light">  <!-- Атрибут темы -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block title %}Ticket System{% endblock %}</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    {% block extra_css %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/custom.css') }}">
    {% endblock %}
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
        <a class="navbar-brand" href="{{ url_for('ticket.dashboard') }}">Ticket System</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
                <!-- Переключатель темы -->
                <li class="nav-item ms-2">
                    <div class="form-check form-switch my-1 ms-3">
                        <input class="form-check-input" type="checkbox" id="overlayToggle">
                        <label class="form-check-label text-white" for="overlayToggle">
                            Показывать оверлей
                        </label>
                    </div>
                </li>
                <li></li>
                <li class="nav-item ms-3">
                    <div class="form-check form-switch my-1">
                        <input class="form-check-input" type="checkbox" id="darkModeSwitch">
                        <label class="form-check-label text-white" for="darkModeSwitch">
                            <i class="bi bi-moon"></i>
                        </label>
                    </div>
                </li>

                {% if current_user.is_authenticated %}
                <li class="nav-item">
                    <a class="nav-link" href="{{ url_for('profile.profile') }}">Профиль</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{{ url_for('auth.logout') }}">Выйти</a>
                </li>
                {% else %}
                <li class="nav-item">
                    <a class="nav-link" href="{{ url_for('auth.login') }}">Войти</a>
                </li>
                {% endif %}
            </ul>
        </div>
    </div>
</nav>

<div class="container mt-4">
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    {% for category, message in messages %}
    <div class="alert alert-{{ category }} alert-dismissible fade show">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endfor %}
    {% endif %}
    {% endwith %}

    {% block content %}{% endblock %}
</div>
<!-- Overlay для включения уведомлений -->
<div id="notification-overlay" class="active">
    <button id="enable-notifications-btn">Включить уведомления</button>
</div>

<style>
#notification-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    backdrop-filter: blur(0);
    background: rgba(0,0,0,0);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 2000;
    opacity: 0;
    transition: backdrop-filter 0.5s ease, background 0.5s ease, opacity 0.5s ease;
    pointer-events: none; /* чтобы не блокировать клики, пока overlay невидим */
}

#notification-overlay.active {
    opacity: 1;
    backdrop-filter: blur(8px);
    background: rgba(0,0,0,0.4);
    pointer-events: all; /* активируем клики */
}

#enable-notifications-btn {
    padding: 1rem 2rem;
    font-size: 1.3rem;
    border: none;
    border-radius: 12px;
    background-color: #0d6efd;
    color: white;
    cursor: pointer;
    box-shadow: 0 6px 16px rgba(0,0,0,0.4);
    transform: scale(0.5);
    opacity: 0;
    transition: transform 0.4s ease, opacity 0.4s ease;
}

#notification-overlay.active #enable-notifications-btn {
    transform: scale(1);
    opacity: 1;
}
</style>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const overlay = document.getElementById('notification-overlay');
    const enableBtn = document.getElementById('enable-notifications-btn');
    const overlayToggle = document.getElementById('overlayToggle');

    // Состояние уведомлений
    window.soundEnabled = false;

    // Восстанавливаем выбор пользователя из localStorage
    const overlayEnabled = localStorage.getItem("overlayEnabled") !== "false"; 
    overlayToggle.checked = overlayEnabled;
    if (!overlayEnabled) {
        overlay.classList.remove("active");
    }

    // Переключатель в navbar
    overlayToggle.addEventListener("change", () => {
        const enabled = overlayToggle.checked;
        localStorage.setItem("overlayEnabled", enabled);
        if (enabled) {
            overlay.classList.add("active");
        } else {
            overlay.classList.remove("active");
        }
    });

    // Кнопка внутри оверлея
    enableBtn.addEventListener('click', () => {
        window.soundEnabled = true;
        overlay.classList.remove('active');
        console.log("Уведомления и звук включены");
    });
});
</script>

<!-- Bootstrap JS Bundle with Popper -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

<!-- Скрипт для переключения темы -->
<script>
    // Проверяем сохранённую тему при загрузке
    document.addEventListener('DOMContentLoaded', function() {
        const savedTheme = localStorage.getItem('bsTheme') || 'light';
        document.documentElement.setAttribute('data-bs-theme', savedTheme);

        // Устанавливаем состояние переключателя
        const darkModeSwitch = document.getElementById('darkModeSwitch');
        if (savedTheme === 'dark') {
            darkModeSwitch.checked = true;
            // Меняем иконку на солнце
            darkModeSwitch.nextElementSibling.innerHTML = '<i class="bi bi-sun"></i>';
        }

        // Обработчик переключения темы
        darkModeSwitch.addEventListener('change', function() {
            const newTheme = this.checked ? 'dark' : 'light';
            document.documentElement.setAttribute('data-bs-theme', newTheme);
            localStorage.setItem('bsTheme', newTheme);

            // Меняем иконку
            this.nextElementSibling.innerHTML = this.checked
                ? '<i class="bi bi-sun"></i>'
                : '<i class="bi bi-moon"></i>';
        });
    });
</script>

<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {
    const overlay = document.getElementById('notification-overlay');
    const enableBtn = document.getElementById('enable-notifications-btn');

    // Сохраняем состояние звука и уведомлений
    window.soundEnabled = false;

    // Socket.IO
    const socket = io();
    const audio = new Audio("{{ url_for('static', filename='sounds/notify.mp3') }}");
    let unread = JSON.parse(localStorage.getItem('unreadTickets') || '{}');

    function highlightCard(ticket_id) {
        const card = document.querySelector(`.pricing-card[data-ticket-id="${ticket_id}"]`);
        if (!card) return false;
        card.classList.add("highlight");
        const container = card.querySelector(".avatar-container");
        if (container) {
            let badge = container.querySelector(".msg-badge");
            if (!badge) {
                badge = document.createElement("span");
                badge.className = "msg-badge position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger";
                badge.style.fontSize = "0.7rem";
                container.appendChild(badge);
            }
            badge.textContent = unread[ticket_id];
        }
        return true;
    }

    // Обработчик включения уведомлений
    enableBtn.addEventListener('click', () => {
        window.soundEnabled = true; // включаем звук
        overlay.style.display = 'none'; // скрываем overlay
        console.log("Уведомления и звук включены");

        // Подсвечиваем уже непросмотренные карточки
        Object.keys(unread).forEach(ticket_id => highlightCard(ticket_id));
    });

    // Обработка новых сообщений
    socket.on("new_message", (data) => {
        if (!unread[data.ticket_id]) unread[data.ticket_id] = 0;
        unread[data.ticket_id]++;
        localStorage.setItem('unreadTickets', JSON.stringify(unread));

        // Воспроизводим звук и показываем toast только если включено
        if (window.soundEnabled) audio.play().catch(()=>{});

        highlightCard(data.ticket_id);

        const toastContainer = document.getElementById('toast-container');
        if (toastContainer) {
            const toastEl = document.createElement('div');
            toastEl.className = 'toast align-items-center text-bg-primary border-0';
            toastEl.role = 'alert';
            toastEl.ariaLive = 'assertive';
            toastEl.ariaAtomic = 'true';
            toastEl.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        Новое сообщение в тикете #${data.ticket_id}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>`;
            toastContainer.appendChild(toastEl);
            const bsToast = new bootstrap.Toast(toastEl);
            bsToast.show();
        }
    });

    // Очистка подсветки при клике на карточку
    document.querySelectorAll(".pricing-card").forEach(card => {
        card.addEventListener('click', () => {
            const tid = card.dataset.ticketId;
            card.classList.remove('highlight');
            if (unread[tid]) { 
                delete unread[tid]; 
                localStorage.setItem('unreadTickets', JSON.stringify(unread));
            }
            const badge = card.querySelector(".msg-badge");
            if (badge) badge.remove();
        });
    });
});
</script>

<div id="toast-container" class="position-fixed bottom-0 end-0 p-3" style="z-index: 1080;"></div>
</html>