{% extends "base.html" %}
{% block content %}
<h2>Поиск продаж</h2>
{% set currency_names = {'WMR': '₽', 'WMZ': '$', 'WML': 'Ł', 'WMT':'USDT', 'WME':'€'} %}
<form method="POST">
    {{ form.hidden_tag() }}
    <div class="mb-3">
        {{ form.query.label }}<br>
        {{ form.query(class="form-control") }}
    </div>
    <button type="submit" class="btn btn-primary">{{ form.submit.label }}</button>
</form>

{% if results %}
<h3 class="mt-4">Результаты:</h3>
<ul class="list-group">
    {% for sale in results %}
    <li class="list-group-item">
        {% if sale.invoice_id in tickets_by_invoice %}
            <a href="{{ url_for('ticket.view_ticket', ticket_id=tickets_by_invoice[sale.invoice_id]) }}" 
            class="text-decoration-none">
                <strong>Заказ #{{ sale.invoice_id }}</strong>
            </a><br>
        {% else %}
            <strong>Заказ #{{ sale.invoice_id }}</strong><br>
        {% endif %}
        Наименование товара: {{ sale.product_name }}<br>
        Ключ/Entry: {{ sale.product_entry }}<br>
        Email: {{ sale.email }}<br>
        IP: {{ sale.ip }}<br>
        Дата оплаты: {{ sale.date_pay.strftime('%Y-%m-%d %H:%M:%S') if sale.date_pay else '—' }}<br>
        Метод оплаты: {{ sale.method_pay or '—' }}<br>
        Цена: {{ sale.amount_in or '—' }} {{ currency_names.get(sale.amount_currency) }}
    </li>
    {% endfor %}
</ul>
{% elif form.query.data %}
<p class="mt-4 text-muted">Ничего не найдено.</p>
{% endif %}
{% endblock %}
