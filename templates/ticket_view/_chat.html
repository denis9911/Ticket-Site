<!-- Чат поддержки -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-chat-left-text"></i> Чат поддержки</h5>
    </div>

    <!-- Основной контейнер чата  -->
    <div class="outer" style="height: 400px; overflow-y: auto;">
        <div class="inner">
            {% for message in ticket.messages|reverse %}
            <div class="mb-3 {% if message.user_id == current_user.id %}text-end{% endif %}">
                <div class="card">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div class="d-flex align-items-center">
                                {% if message.author.avatar %}
                                <img src="{{ url_for('static', filename=message.author.avatar) }}"
                                     class="rounded-circle me-2" width="32" height="32" alt="Аватар">
                                {% else %}
                                <div class="bg-secondary rounded-circle me-2 d-flex align-items-center justify-content-center"
                                     style="width: 32px; height: 32px;">
                                    <span class="small">{{ (message.author.display_name or message.author.username)|first|upper }}</span>
                                </div>
                                {% endif %}
                                <span class="{% if message.user_id == current_user.id %}{% else %}text-muted{% endif %}">
                                    {{ message.author.display_name or message.author.username }}
                                </span>
                            </div>
                            <small class="{% if message.user_id == current_user.id %}text-white-50{% else %}text-muted{% endif %}">
                                {% if message.created_at %}
                                <span class="utc-time" data-utc="{{ message.created_at.isoformat() }}Z">
                                    {{ message.created_at.strftime('%Y-%m-%d %H:%M UTC') }}
                                </span>
                                {% else %}
                                <span>Дата не указана</span>
                                {% endif %}
                                {% if message.user_id == current_user.id or current_user.is_admin %}
                                <form method="POST"
                                      action="{{ url_for('ticket.delete_message', message_id=message.id) }}"
                                      onsubmit="return confirm('Удалить это сообщение?')"
                                      style="display:inline;">
                                    <button type="submit"
                                            class="btn btn-link p-0 ms-2 {% if message.user_id == current_user.id %}text-white-50{% else %}text-muted{% endif %}">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </form>
                                {% endif %}
                            </small>
                        </div>

                        <p class="mb-0">{{ message.content }}</p>

                        {% if message.attachments %}
                        <div class="mt-2">
                            {% for img in message.attachments %}
                                <a href="{{ img.url() }}" target="_blank">
                                    <img src="{{ img.url() }}" alt="Вложение" class="img-thumbnail me-2 mb-2" style="max-height: 150px;">
                                </a>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% else %}
            <div class="text-center text-muted py-4">
                <i class="bi bi-chat-square-text" style="font-size: 2rem;"></i>
                <p class="mt-2">Пока нет сообщений в чате</p>
            </div>
            {% endfor %}
        </div>
    </div>

    {% if ticket.status.category != 'final' %}
    <div class="card-footer">
        <form method="POST" id="message-form" enctype="multipart/form-data" class="d-flex flex-column w-100">
            {{ form.hidden_tag() }}
            
            <!-- Поле сообщения растянуто на всю ширину -->
            <div class="mb-2 w-100">
                {{ form.content(class="form-control w-100", placeholder="Напишите сообщение...", rows="2") }}
            </div>

            <!-- Вложение -->
            <div class="mb-2 w-100">
                {{ form.attachment(class="form-control w-100", id="attachmentInput") }}
            </div>

            <!-- Кнопка -->
            <button class="btn btn-primary w-100" type="submit">
                <i class="bi bi-send"></i> Отправить
            </button>
        </form>
    </div>
    {% endif %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const messageForm = document.getElementById('message-form');
    const attachmentInput = document.getElementById('attachmentInput');

    // Обработчик вставки из буфера
    messageForm.addEventListener('paste', async (event) => {
        const items = (event.clipboardData || event.originalEvent.clipboardData).items;
        for (const item of items) {
            if (item.type.indexOf('image') !== -1) {
                const file = item.getAsFile();

                // Создаем объект FileList для input
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);
                attachmentInput.files = dataTransfer.files;

                // Для предпросмотра (если нужно)
                const reader = new FileReader();
                reader.onload = (e) => {
                    const imgPreview = document.createElement('img');
                    imgPreview.src = e.target.result;
                    imgPreview.className = 'img-thumbnail me-2 mb-2';
                    imgPreview.style.maxHeight = '100px';
                    attachmentInput.parentNode.appendChild(imgPreview);
                };
                reader.readAsDataURL(file);
            }
        }
    });
});
</script>